(function () {function b(t,o){if(!(t instanceof o))throw new TypeError("Cannot call a class as a function")}function c(t,o){for(var e=0;e<o.length;e++){var r=o[e];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(t,r.key,r)}}function d(t,o,e){return o&&c(t.prototype,o),e&&c(t,e),t}var a={createStyleSheet:function(e){if(!document.getElementById("gameStyleSheet")){var t=document.createElement("style");t.type="text/css",t.id="gameStyleSheet",t.innerHTML=e,document.head.appendChild(t)}},createCanvas:function(e){e=e||document.body;var t=document.createElement("div"),a=document.createElement("canvas");return t.className="game-wrapper",a.className="game-ui",t.appendChild(a),e.appendChild(t),{wrapper:t,canvas:a}},getPixRatio:function(e){var t=e.backingStorePixelRatio||e.webkitBackingStorePixelRatio||e.mozBackingStorePixelRatio||1;return(window.devicePixelRatio||1)/t},isFunc:function(e){return"function"==typeof e},getRndInt:function(e,t){return Math.floor(Math.random()*(t-e+1)+e)}};a.createStyleSheet("* {\r\n  padding: 0;\r\n  margin: 0;\r\n  box-sizing: border-box;\r\n}\r\n\r\nbody {\r\n  background-color: #fbe9e7;\r\n}\r\n\r\n.game-wrapper {\r\n  max-width: 480px;\r\n  margin: auto;\r\n  position: relative;\r\n}\r\n\r\n.game-wrapper canvas.game-ui {\r\n  display: block;\r\n  width: 100%;\r\n  padding: 3px;\r\n  border-radius: 4px;\r\n  background-color: #fff;\r\n  cursor: pointer;\r\n  -webkit-tap-highlight-color: transparent;\r\n  box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);\r\n}\r\n\r\n.game-wrapper .scores {\r\n  position: absolute;\r\n  text-align: center;\r\n  color: #212121;\r\n}");var g=function(){function t(o){var e=o.row,r=o.col,n=o.color;b(this,t),this.row=e,this.col=r,this.color=n}return d(t,[{key:"draw",value:function(t){var o=t.context,e=t.size,r=t.space;o.save(),o.fillStyle=this.color,o.fillRect(this.col*e+r,this.row*e+r,e-r,e-r),o.restore()}}]),t}(),h=function(){function t(o){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};b(this,t),this.callbacks=e;var r=utils.createCanvas(o),n=r.wrapper,i=r.canvas;this.wrapper=n,this.canvas=i,this.context=this.canvas.getContext("2d"),this.pixRatio=a.getPixRatio(this.context),this.addListener()}return d(t,[{key:"initUI",value:function(t){var o=t.rows,e=t.cols,r=t.colors,n=void 0===r?[]:r;if(n.length<3)throw new Error("\u8BF7\u81F3\u5C11\u63D0\u4F9B3\u79CD\u989C\u8272.");if(this.rows=o||e,this.cols=e,this.rows*this.cols%2)throw new Error("\u884C\u548C\u5217\u7684\u79EF\u5FC5\u987B\u662F2\u7684\u500D\u6570.");this.colors=n,this.score=0,this.blockSize=0,this.blockSpace=2*this.pixRatio,this.updateSize(),this.blocks=this.genBlocks(),this.drawBlocks()}},{key:"updateSize",value:function(){var t,o=this.canvas.offsetWidth;this.canvas.width=t=this.pixRatio*o,this.blockSize=(t-this.blockSpace)/this.cols,this.canvas.height=this.rows*this.blockSize+this.blockSpace}},{key:"genBlocks",value:function(){for(var t=this.rows*this.cols,o=this.colors.length,e=[],r=[],n=0,i=0;i<t/2;i++)e.push(this.colors[a.getRndInt(0,o-1)]);e=e.concat(e).sort(function(){return Math.random()-.5});for(var s=0;s<this.rows;s++)for(var c=0;c<this.cols;c++)r.push(new g({row:s,col:c,color:e[n]})),n++;return r}},{key:"drawBlocks",value:function(){var t=this.canvas,o=t.width,e=t.height,r=this.context,n=this.blockSize,i=this.blockSpace;this.context.clearRect(0,0,+o,+e),this.blocks.forEach(function(t){return t&&t.draw({context:r,size:n,space:i})})}},{key:"getCurBlock",value:function(t){for(var o=(t.offsetX||t.pageX)*this.pixRatio,e=(t.offsetY||t.pageY)*this.pixRatio,r=Math.floor(o/this.blockSize),n=Math.floor(e/this.blockSize),i=0,s=this.blocks.length;i<s;i++){var c=this.blocks[i];if(c&&c.row===n&&c.col===r)return c}}},{key:"getTRBLBlocks",value:function(t){var o=this.blocks.indexOf(t),e=t.row,r=t.col,n=this.blocks.find(function(t){return t&&t.col===r&&t.row===e-1}),i=this.blocks.find(function(t){return t&&t.row===e&&t.col===r+1}),s=this.blocks.find(function(t){return t&&t.col===r&&t.row===e+1}),c=this.blocks.find(function(t){return t&&t.row===e&&t.col===r-1}),a=[n,i,s,c];return o%this.cols==0?a=[n,i,s]:(o+1)%this.cols==0&&(a=[n,s,c]),a.filter(function(t){return t})}},{key:"getIdentColorBlocks",value:function(t){for(var o=this,e=[],r=[t],n=function(){var t=r.pop();-1===e.indexOf(t)&&e.push(t),o.getTRBLBlocks(t).forEach(function(o){o.color===t.color&&-1===e.indexOf(o)&&r.push(o)})};r.length;)n();return e}},{key:"removeBlocks",value:function(t){var o=this;t.forEach(function(t){o.blocks.splice(o.blocks.indexOf(t),1,null)})}},{key:"drawScores",value:function(t){var o=this,e=window.getComputedStyle(this.canvas,null),r=parseInt(e.paddingLeft),n=parseInt(e.paddingTop),i=document.createElement("div");return i.innerHTML=t.map(function(e){var i=e.row*o.blockSize/o.pixRatio+n+"px",s=e.col*o.blockSize/o.pixRatio+r+"px",c=o.blockSize/o.pixRatio+"px";return"<span class=\"scores\" style=\"top:".concat(i,";left:").concat(s,";width:").concat(c,";height:").concat(c,";line-height:").concat(c,"\">+").concat(t.length,"</span>")}).join(""),this.wrapper.appendChild(i),new Promise(function(t){setTimeout(function(){o.wrapper.removeChild(i),t()},300)})}},{key:"getEmptyCount",value:function(t){return this.rows-t.row-this.blocks.filter(function(o){return o&&o.col===t.col&&o.row>t.row}).length-1}},{key:"getBlocksByCol",value:function(t){return this.blocks.filter(function(o){return o&&o.col===t})}},{key:"dropBlocks",value:function(t){var o=this,e=[];t.forEach(function(t){return-1===e.indexOf(t.col)&&e.push(t.col)}),e.forEach(function(t){var e=[],r=o.getBlocksByCol(t);r.forEach(function(t){return e.push(o.getEmptyCount(t))}),r.forEach(function(t,o){return t.row+=e[o]})})}},{key:"isEmptyCol",value:function(t){return!this.blocks.filter(function(o){return o&&o.col===t}).length}},{key:"getEmptyCols",value:function(){for(var t=[],o=0;o<this.cols-1;o++)this.isEmptyCol(o)&&t.push(o);return t}},{key:"moveCols",value:function(){var t=this.getEmptyCols();this.blocks.forEach(function(o){return o&&(o.col-=t.filter(function(t){return t<o.col}).length)})}},{key:"doneCheck",value:function(){for(var t=this.blocks.filter(function(t){return t}),o=0,e=t.length;o<e;o++){var r=t[o];if(this.getIdentColorBlocks(r).length>1)return!1}return!0}},{key:"addListener",value:function(){this.canvas.addEventListener("click",this.onClick.bind(this))}},{key:"onClick",value:function(t){var o=this,e=this.getCurBlock(t);if(e){var r=this.getIdentColorBlocks(e),n=r.length;if(!(n<2)){var i=this.callbacks.onDone;this.score+=n*n,this.removeBlocks(r),this.drawBlocks(),this.drawScores(r).then(function(){o.dropBlocks(r),o.moveCols(),o.drawBlocks(),o.doneCheck()&&setTimeout(function(){return a.isFunc(i)&&i(o.score)},100)})}}}}]),t}(),e={cols:10,colors:["#22a6ea","#f44e4e","#b3cc25","#f1a30c","#b854e6"]},f=new h(null,{onDone:function(t){alert("\u6CA1\u6709\u53EF\u6D88\u9664\u7684\u65B9\u5757\u4E86\uFF0C\u4F60\u7684\u5F97\u5206: ".concat(t)),f.initUI(e)}});f.initUI(e);})();